name: ğŸ—³ï¸ Vote Automation 24/7

on:
  schedule:
    # Vote 24/7 toutes les 1h30 (16 votes par jour)
    # Utilise environ 2400 minutes/mois sur les 3000 disponibles avec GitHub Pro
    - cron: '0 0 * * *'     # 00h00
    - cron: '30 1 * * *'    # 01h30  
    - cron: '0 3 * * *'     # 03h00
    - cron: '30 4 * * *'    # 04h30
    - cron: '0 6 * * *'     # 06h00
    - cron: '30 7 * * *'    # 07h30
    - cron: '0 9 * * *'     # 09h00
    - cron: '30 10 * * *'   # 10h30
    - cron: '0 12 * * *'    # 12h00
    - cron: '30 13 * * *'   # 13h30
    - cron: '0 15 * * *'    # 15h00
    - cron: '30 16 * * *'   # 16h30
    - cron: '0 18 * * *'    # 18h00
    - cron: '30 19 * * *'   # 19h30
    - cron: '0 21 * * *'    # 21h00
    - cron: '30 22 * * *'   # 22h30
  
  workflow_dispatch:  # Permet de dÃ©clencher manuellement pour les tests
    inputs:
      test_mode:
        description: 'Mode test (true/false)'
        required: false
        default: 'false'

jobs:
  vote:
    runs-on: ubuntu-latest
    timeout-minutes: 15  # Limite de sÃ©curitÃ© pour Ã©viter les blocages
    
    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4
    
    - name: ğŸ Setup Python 3.9
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: ğŸ“¦ Cache pip dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
    
    - name: ğŸ”§ Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y wget unzip xvfb
    
    - name: ğŸŒ Install Google Chrome
      run: |
        wget -q -O - https://dl.google.com/linux/linux_signing_key.pub | sudo apt-key add -
        sudo sh -c 'echo "deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main" >> /etc/apt/sources.list.d/google.list'
        sudo apt-get update
        sudo apt-get install -y google-chrome-stable
        
        # VÃ©rifier l'installation
        google-chrome --version
    
    - name: ğŸš— Install ChromeDriver
      run: |
        # Obtenir la version de Chrome installÃ©e
        CHROME_VERSION=$(google-chrome --version | cut -d " " -f3 | cut -d "." -f1-3)
        echo "Chrome version: $CHROME_VERSION"
        
        # Obtenir la version compatible de ChromeDriver
        CHROMEDRIVER_VERSION=$(curl -s "https://chromedriver.storage.googleapis.com/LATEST_RELEASE_$CHROME_VERSION")
        echo "ChromeDriver version: $CHROMEDRIVER_VERSION"
        
        # TÃ©lÃ©charger et installer ChromeDriver
        wget -O /tmp/chromedriver.zip "https://chromedriver.storage.googleapis.com/$CHROMEDRIVER_VERSION/chromedriver_linux64.zip"
        sudo unzip /tmp/chromedriver.zip -d /usr/local/bin/
        sudo chmod +x /usr/local/bin/chromedriver
        
        # VÃ©rifier l'installation
        chromedriver --version
    
    - name: ğŸ“š Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: ğŸ”‘ Create .env file from secrets
      run: |
        echo "api_key=${{ secrets.CAPTCHA_API_KEY }}" > .env
        echo "username=${{ secrets.USERNAME }}" >> .env
        
        # VÃ©rifier que les secrets sont bien configurÃ©s
        if [ -z "${{ secrets.CAPTCHA_API_KEY }}" ]; then
          echo "âŒ ERREUR: CAPTCHA_API_KEY non configurÃ© dans les secrets GitHub"
          exit 1
        fi
        
        echo "âœ… Fichier .env crÃ©Ã© avec succÃ¨s"
    
    - name: ğŸ—³ï¸ Execute vote script
      run: |
        echo "ğŸš€ DÃ©marrage du vote automatique..."
        echo "â° Heure actuelle: $(date)"
        echo "ğŸŒ Timezone: $(timedatezone)"
        
        # Lancer le script avec retry automatique
        for attempt in {1..3}; do
          echo "ğŸ”„ Tentative $attempt/3..."
          
          if python3 mtcaptcha_github_actions.py --headless; then
            echo "ğŸ‰ Vote rÃ©ussi Ã  la tentative $attempt"
            echo "VOTE_SUCCESS=true" >> $GITHUB_ENV
            break
          else
            echo "âŒ Ã‰chec Ã  la tentative $attempt"
            if [ $attempt -lt 3 ]; then
              echo "â³ Attente de 30 secondes avant la prochaine tentative..."
              sleep 30
            else
              echo "ğŸ’¥ Toutes les tentatives ont Ã©chouÃ©"
              echo "VOTE_SUCCESS=false" >> $GITHUB_ENV
              exit 1
            fi
          fi
        done
      env:
        DISPLAY: ':99'
        PYTHONUNBUFFERED: '1'
    
    - name: ğŸ“Š Job Summary
      if: always()
      run: |
        echo "## ğŸ—³ï¸ Vote Automation Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **Date/Heure**: $(date)" >> $GITHUB_STEP_SUMMARY
        echo "- **RÃ©sultat**: ${{ env.VOTE_SUCCESS == 'true' && 'âœ… SuccÃ¨s' || 'âŒ Ã‰chec' }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Runner**: ${{ runner.os }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Workflow**: ${{ github.workflow }}" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ env.VOTE_SUCCESS }}" = "true" ]; then
          echo "- **Status**: ğŸ‰ Vote effectuÃ© avec succÃ¨s" >> $GITHUB_STEP_SUMMARY
        else
          echo "- **Status**: âš ï¸ Vote Ã©chouÃ© - vÃ©rifier les logs" >> $GITHUB_STEP_SUMMARY
        fi
    
    - name: ğŸ“¸ Upload screenshots on failure
      if: failure()
      uses: actions/upload-artifact@v3
      with:
        name: vote-failure-${{ github.run_number }}
        path: |
          *.log
          screenshots/
        retention-days: 7
    
    - name: ğŸ”” Notify on failure (optionnel)
      if: ${{ failure() && secrets.DISCORD_WEBHOOK != '' }}
      run: |
        curl -X POST -H 'Content-type: application/json' \
        --data "{\"content\":\"âŒ Vote automation failed at $(date)\\nWorkflow: ${{ github.workflow }}\\nRun: ${{ github.run_id }}\"}" \
        ${{ secrets.DISCORD_WEBHOOK }}